# KEDA ScaledObject for Redis Queue-based autoscaling
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: crawler-worker-scaler
  namespace: crawler
spec:
  scaleTargetRef:
    name: crawler-worker  # Target Deployment name
  pollingInterval: 15     # Check every 15 seconds
  cooldownPeriod: 300     # Wait 5 minutes before scaling down
  minReplicaCount: 1      # Minimum 1 pod
  maxReplicaCount: 20     # Maximum 20 pods
  triggers:
  - type: redis
    metadata:
      address: redis-service.crawler.svc.cluster.local:6379
      listName: queue_priority_high
      listLength: "100"    # Scale up when queue > 100 items
      activationListLength: "10"  # Activate scaling when > 10 items
  - type: redis
    metadata:
      address: redis-service.crawler.svc.cluster.local:6379
      listName: queue_priority_medium
      listLength: "200"
      activationListLength: "20"
  - type: redis
    metadata:
      address: redis-service.crawler.svc.cluster.local:6379
      listName: queue_priority_normal
      listLength: "500"
      activationListLength: "50"

---
# Fallback HPA for CPU-based scaling (if KEDA is not available)
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: crawler-worker-hpa
  namespace: crawler
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: crawler-worker
  minReplicas: 1
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
      - type: Pods
        value: 2
        periodSeconds: 30
      selectPolicy: Max
