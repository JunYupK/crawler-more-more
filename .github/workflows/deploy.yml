name: Deploy Crawler

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      deploy_mode:
        description: "배포 모드 (check: 테스트만, accept: 테스트+배포)"
        required: true
        default: "check"
        type: choice
        options:
          - check
          - accept

jobs:
  pre_deploy_tests:
    name: Pre-deploy test verification
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./crawler-challenge
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install "asyncpg>=0.29.0"
          pip install pytest

      - name: Verify regression tests before CD
        run: |
          pytest -q tests/test_kafka_url_embedding.py tests/test_entrypoint_separation.py

  deploy:
    name: Deploy to Mac
    needs: pre_deploy_tests
    # push 시 자동 배포, 또는 workflow_dispatch accept 모드 시 배포
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_mode == 'accept')
    runs-on: self-hosted
    defaults:
      run:
        working-directory: ./crawler-challenge
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Deploy with Docker Compose
        run: |
          echo "배포 시작: 기존 컨테이너 중지 및 최신 코드 빌드"

          # 1. 최신 코드로 이미지 다시 빌드 (캐시 활용)
          docker compose -f mac/docker-compose.yml build

          # 2. 컨테이너 재시작 (변경된 부분만 감지해서 교체함)
          docker compose -f mac/docker-compose.yml up -d

          # 3. 불필요한 이미지 정리 (용량 확보)
          docker image prune -f

      - name: Health Check (생존 확인)
        run: |
          sleep 5
          docker compose -f mac/docker-compose.yml ps

  deploy_skipped_notice:
    name: Deploy skipped (check mode)
    needs: pre_deploy_tests
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_mode != 'accept'
    runs-on: ubuntu-latest
    steps:
      - name: Print skip reason
        run: |
          echo "배포 모드가 '${{ github.event.inputs.deploy_mode }}' 이므로 배포를 건너뜁니다."
          echo "배포를 진행하려면 workflow_dispatch에서 deploy_mode=accept 로 실행하세요."
