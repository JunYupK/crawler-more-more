name: Deploy Crawler

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      deploy_mode:
        description: "ë°°í¬ ëª¨ë“œ (accept ì¼ ë•Œë§Œ ë°°í¬ ì‹¤í–‰)"
        required: true
        default: "check"
        type: choice
        options:
          - check
          - accept

jobs:
  pre_deploy_tests:
    name: Pre-deploy test verification
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./crawler-challenge
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install "asyncpg>=0.29.0"
          pip install pytest

      - name: Verify regression tests before CD
        run: |
          pytest -q tests/test_kafka_url_embedding.py tests/test_entrypoint_separation.py

  deploy:
    name: Deploy (accept mode only)
    needs: pre_deploy_tests
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_mode == 'accept'
    runs-on: self-hosted
    defaults:
      run:
        working-directory: ./crawler-challenge
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Deploy with Docker Compose
        run: |
          echo "ğŸš€ ë°°í¬ ì‹œì‘: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ìµœì‹  ì½”ë“œ ë¹Œë“œ"

          # 1. ìµœì‹  ì½”ë“œë¡œ ì´ë¯¸ì§€ ë‹¤ì‹œ ë¹Œë“œ (ìºì‹œ í™œìš©)
          docker compose build

          # 2. ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ (ë³€ê²½ëœ ë¶€ë¶„ë§Œ ê°ì§€í•´ì„œ êµì²´í•¨)
          docker compose up -d

          # 3. ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì •ë¦¬ (ìš©ëŸ‰ í™•ë³´)
          docker image prune -f

      - name: Health Check (ìƒì¡´ í™•ì¸)
        run: |
          sleep 5
          docker compose ps

  deploy_skipped_notice:
    name: Deploy skipped notice
    needs: pre_deploy_tests
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_mode != 'accept'
    runs-on: ubuntu-latest
    steps:
      - name: Print skip reason
        run: |
          echo "ë°°í¬ ëª¨ë“œê°€ '${{ github.event.inputs.deploy_mode }}' ì´ë¯€ë¡œ ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
          echo "ë°°í¬ë¥¼ ì§„í–‰í•˜ë ¤ë©´ workflow_dispatchì—ì„œ deploy_mode=accept ë¡œ ì‹¤í–‰í•˜ì„¸ìš”."
