name: Deploy Crawler

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      deploy_mode:
        description: "배포 모드 (check: 테스트만, accept: 테스트+배포)"
        required: true
        default: "check"
        type: choice
        options:
          - check
          - accept

jobs:
  pre_deploy_tests:
    name: Pre-deploy test verification
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./crawler-challenge
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install "asyncpg>=0.29.0"
          pip install pytest

      - name: Verify regression tests before CD
        run: |
          pytest -q tests/test_kafka_url_embedding.py tests/test_entrypoint_separation.py

  # ── Mac 배포 (Docker 기반 sharded crawler) ───────────────────────────
  deploy_mac:
    name: Deploy to Mac
    needs: pre_deploy_tests
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_mode == 'accept')
    runs-on: [self-hosted, mac]
    defaults:
      run:
        working-directory: ./crawler-challenge
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Deploy with Docker Compose
        run: |
          echo "배포 시작: 기존 컨테이너 중지 및 최신 코드 빌드"

          # 1. 최신 코드로 이미지 다시 빌드 (캐시 활용)
          docker compose -f mac/docker-compose.yml build

          # 2. 컨테이너 재시작 (변경된 부분만 감지해서 교체함)
          docker compose -f mac/docker-compose.yml up -d

          # 3. 불필요한 이미지 정리 (용량 확보)
          docker image prune -f

      - name: Health Check (생존 확인)
        run: |
          sleep 5
          docker compose -f mac/docker-compose.yml ps

  # ── Desktop 배포 (Python 네이티브 파이프라인) ────────────────────────
  deploy_desktop:
    name: Deploy to Desktop
    needs: pre_deploy_tests
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_mode == 'accept')
    runs-on: [self-hosted, desktop]
    defaults:
      run:
        working-directory: ./crawler-challenge
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install/update Python dependencies
        run: |
          pip install -e ".[desktop]"

      - name: Restart pipeline services
        run: |
          echo "Desktop 파이프라인 재시작"

          # 1. 기존 서비스 중지
          ./desktop/start.sh stop || true

          # 2. 인프라 컨테이너 최신화 (Kafka, MinIO, PostgreSQL, Redis)
          docker compose -f desktop/docker-compose.yml up -d

          # 3. 파이프라인 서비스 재시작
          #    - 로그 파일로 리다이렉트해 배포 실패 시 원인 추적 가능하게 함
          #    - disown: CI step 종료 후 runner가 process group을 정리해도 생존
          mkdir -p desktop/logs
          nohup ./desktop/start.sh > desktop/logs/pipeline-startup.log 2>&1 &
          disown

          # 시작 대기 — Python 서비스 4개 + Docker 인프라 안정화 대기
          sleep 10

      - name: Health Check (서비스 상태 확인)
        run: |
          ./desktop/start.sh status

  deploy_skipped_notice:
    name: Deploy skipped (check mode)
    needs: pre_deploy_tests
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_mode != 'accept'
    runs-on: ubuntu-latest
    steps:
      - name: Print skip reason
        run: |
          echo "배포 모드가 '${{ github.event.inputs.deploy_mode }}' 이므로 배포를 건너뜁니다."
          echo "배포를 진행하려면 workflow_dispatch에서 deploy_mode=accept 로 실행하세요."
