name: PR Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop ]

jobs:
  pr-validation:
    name: Validate Pull Request
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check PR title format
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        echo "PR Title: ${PR_TITLE}"

        # Check conventional commit format: type(scope): description
        if [[ ! "${PR_TITLE}" =~ ^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?: ]]; then
          echo "‚ùå PR title must follow conventional commits format"
          echo "Examples: feat: add new feature, fix(crawler): resolve timeout issue"
          exit 1
        fi

        echo "‚úÖ PR title format is valid"

    - name: Check PR size
      run: |
        FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
        LINES_CHANGED=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4+$6}')

        echo "Files changed: ${FILES_CHANGED}"
        echo "Lines changed: ${LINES_CHANGED}"

        if [ "${FILES_CHANGED}" -gt "50" ] || [ "${LINES_CHANGED}" -gt "1000" ]; then
          echo "‚ö†Ô∏è Large PR detected (${FILES_CHANGED} files, ${LINES_CHANGED} lines)"
          echo "Consider breaking this into smaller PRs for easier review"
        else
          echo "‚úÖ PR size is reasonable"
        fi

    - name: Check for merge conflicts
      run: |
        git fetch origin ${{ github.base_ref }}
        if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q "^+<<<<<<<"; then
          echo "‚ùå Merge conflicts detected"
          exit 1
        fi
        echo "‚úÖ No merge conflicts"

  code-review:
    name: Automated Code Review
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install review tools
      run: |
        pip install pylint radon bandit
        cd crawler-challenge
        pip install -r requirements.txt

    - name: Run automated review
      run: |
        cd crawler-challenge
        echo "## üîç Automated Code Review" > review.md
        echo "" >> review.md

        # Complexity analysis
        echo "### Code Complexity" >> review.md
        echo "\`\`\`" >> review.md
        radon cc . -a -s -nb 2>/dev/null >> review.md || echo "No complexity issues" >> review.md
        echo "\`\`\`" >> review.md
        echo "" >> review.md

        # Maintainability
        echo "### Maintainability Index" >> review.md
        echo "\`\`\`" >> review.md
        radon mi . -s -nb 2>/dev/null >> review.md || echo "Good maintainability" >> review.md
        echo "\`\`\`" >> review.md

        cat review.md

    - name: Comment PR with review
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const review = fs.readFileSync('crawler-challenge/review.md', 'utf8');

          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: review
          });

  performance-check:
    name: Performance Impact Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        cd crawler-challenge
        pip install -r requirements.txt

    - name: Check for performance-sensitive changes
      run: |
        # Check if performance-critical files were modified
        CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

        PERF_FILES="polite_crawler.py multithreaded_crawler.py distributed_crawler.py"

        for file in ${PERF_FILES}; do
          if echo "${CHANGED_FILES}" | grep -q "${file}"; then
            echo "‚ö†Ô∏è Performance-critical file modified: ${file}"
            echo "Please ensure performance testing is done before merging"
          fi
        done

  label-pr:
    name: Auto-label PR
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Auto-label based on files
      uses: actions/github-script@v7
      with:
        script: |
          const changedFiles = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });

          const labels = new Set();

          changedFiles.data.forEach(file => {
            if (file.filename.includes('.github/workflows')) labels.add('ci/cd');
            if (file.filename.includes('k8s/')) labels.add('kubernetes');
            if (file.filename.includes('Dockerfile')) labels.add('docker');
            if (file.filename.includes('README.md') || file.filename.includes('.md')) labels.add('documentation');
            if (file.filename.includes('test')) labels.add('tests');
            if (file.filename.includes('monitoring/')) labels.add('monitoring');
          });

          if (labels.size > 0) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: Array.from(labels)
            });
          }
